# frozen_string_literal: true

require 'net/http'
require 'json'
require 'csv'

def get_data(address, pageSize)
  raise ArgumentError, 'Address must be a string' unless address.is_a?(String)
  raise ArgumentError, 'Page size must be a positive integer' unless pageSize.is_a?(Integer) && pageSize > 0

  uri = URI('https://www.booking.com/dml/graphql')

  query_params = build_query_params(uri)

  headers = build_headers

  file_path = './data.csv'

  uri.query = URI.encode_www_form(query_params)
  https = Net::HTTP.new(uri.host, uri.port)
  https.use_ssl = true
  request = Net::HTTP::Post.new(uri)

  headers.each do |obj|
    request[obj[:key]] = obj[:value]
  end

  request.body = "{\n    \"operationName\": \"FullSearch\",\n    \"variables\": {\n        \"input\": {\n            \"acidCarouselContext\": null,\n            \"childrenAges\": [],\n            \"dates\": {\n                \"checkin\": \"2024-06-18\",\n                \"checkout\": \"2024-06-19\"\n            },\n            \"doAvailabilityCheck\": false,\n            \"encodedAutocompleteMeta\": null,\n            \"enableCampaigns\": true,\n            \"filters\": {\n                \"selectedFilters\": \"distance=3000\"\n            },\n            \"selectedFilterSources\": [\n                \"PREVIOUS\"\n            ],\n            \"flexibleDatesConfig\": {\n                \"broadDatesCalendar\": {\n                    \"checkinMonths\": [],\n                    \"los\": [],\n                    \"startWeekdays\": []\n                },\n                \"dateFlexUseCase\": \"DATE_RANGE\",\n                \"dateRangeCalendar\": {\n                    \"checkin\": [\n                        \"2024-06-18\"\n                    ],\n                    \"checkout\": [\n                        \"2024-06-19\"\n                    ]\n                }\n            },\n            \"forcedBlocks\": null,\n            \"location\": {\n                \"searchString\": \"Bangalore\",\n                \"destType\": \"LATLONG\",\n                \"latitude\": 41.8804017,\n                \"longitude\": -87.6302038\n            },\n            \"metaContext\": {\n                \"metaCampaignId\": 0,\n                \"externalTotalPrice\": null,\n                \"feedPrice\": null,\n                \"hotelCenterAccountId\": null,\n                \"rateRuleId\": null,\n                \"dragongateTraceId\": null,\n                \"pricingProductsTag\": null\n            },\n            \"nbRooms\": 1,\n            \"nbAdults\": 1,\n            \"nbChildren\": 0,\n            \"showAparthotelAsHotel\": true,\n            \"needsRoomsMatch\": false,\n            \"optionalFeatures\": {\n                \"forceArpExperiments\": true,\n                \"testProperties\": false\n            },\n            \"pagination\": {\n                \"rowsPerPage\": 50,\n                \"offset\": 0\n            },\n            \"rawQueryForSession\": \"/searchresults.en-gb.html?label=gen173nr-1BCAEoggI46AdIM1gEaGyIAQGYAQm4AQfIAQzYAQHoAQGIAgGoAgO4AofIxbMGwAIB0gIkNDFkMDkyZDktMDFlZC00NzMxLTkyMjMtNGFhYWIxNjEwMjg12AIF4AIB&sid=aa4f62f572ac5f487c282f0f11ec409c&aid=304142&ss=Bangalore&ssne=Bangalore&ssne_untouched=Bangalore&lang=en-gb&src=index&dest_id=-2090174&dest_type=city&checkin=2024-06-18&checkout=2024-06-19&group_adults=1&no_rooms=1&group_children=0&nflt=distance%3D3000\",\n            \"referrerBlock\": null,\n            \"sbCalendarOpen\": false,\n            \"sorters\": {\n                \"selectedSorter\": null,\n                \"referenceGeoId\": null,\n                \"tripTypeIntentId\": null\n            },\n            \"travelPurpose\": 2,\n            \"seoThemeIds\": [],\n            \"useSearchParamsFromSession\": true,\n            \"merchInput\": {\n                \"testCampaignIds\": []\n            }\n        },\n        \"carouselLowCodeExp\": false\n    },\n    \"extensions\": {},\n    \"query\": \"query FullSearch($input: SearchQueryInput!, $carouselLowCodeExp: Boolean!) {\\n  searchQueries {\\n    search(input: $input) {\\n      ...FullSearchFragment\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n\\nfragment FullSearchFragment on SearchQueryOutput {\\n  banners {\\n    ...Banner\\n    __typename\\n  }\\n  breadcrumbs {\\n    ... on SearchResultsBreadcrumb {\\n      ...SearchResultsBreadcrumb\\n      __typename\\n    }\\n    ... on LandingPageBreadcrumb {\\n      ...LandingPageBreadcrumb\\n      __typename\\n    }\\n    __typename\\n  }\\n  carousels {\\n    ...Carousel\\n    __typename\\n  }\\n  destinationLocation {\\n    ...DestinationLocation\\n    __typename\\n  }\\n  entireHomesSearchEnabled\\n  dateFlexibilityOptions {\\n    enabled\\n    __typename\\n  }\\n  flexibleDatesConfig {\\n    broadDatesCalendar {\\n      checkinMonths\\n      los\\n      startWeekdays\\n      losType\\n      __typename\\n    }\\n    dateFlexUseCase\\n    dateRangeCalendar {\\n      flexWindow\\n      checkin\\n      checkout\\n      __typename\\n    }\\n    __typename\\n  }\\n  filters {\\n    ...FilterData\\n    __typename\\n  }\\n  filtersTrackOnView {\\n    type\\n    experimentHash\\n    value\\n    __typename\\n  }\\n  appliedFilterOptions {\\n    ...FilterOption\\n    __typename\\n  }\\n  recommendedFilterOptions {\\n    ...FilterOption\\n    __typename\\n  }\\n  pagination {\\n    nbResultsPerPage\\n    nbResultsTotal\\n    __typename\\n  }\\n  tripTypes {\\n    ...TripTypesData\\n    __typename\\n  }\\n  results {\\n    ...BasicPropertyData\\n    ...MatchingUnitConfigurations\\n    ...PropertyBlocks\\n    ...BookerExperienceData\\n    priceDisplayInfoIrene {\\n      ...PriceDisplayInfoIrene\\n      __typename\\n    }\\n    licenseDetails {\\n      nextToHotelName\\n      __typename\\n    }\\n    isTpiExclusiveProperty\\n    propertyCribsAvailabilityLabel\\n    mlBookingHomeTags\\n    trackOnView {\\n      experimentTag\\n      __typename\\n    }\\n    __typename\\n  }\\n  searchMeta {\\n    ...SearchMetadata\\n    __typename\\n  }\\n  sorters {\\n    option {\\n      ...SorterFields\\n      __typename\\n    }\\n    __typename\\n  }\\n  oneOfThreeDeal {\\n    ...OneOfThreeDeal\\n    __typename\\n  }\\n  zeroResultsSection {\\n    ...ZeroResultsSection\\n    __typename\\n  }\\n  rocketmilesSearchUuid\\n  previousSearches {\\n    ...PreviousSearches\\n    __typename\\n  }\\n  frontierThemes {\\n    ...FrontierThemes\\n    __typename\\n  }\\n  merchComponents {\\n    ...MerchRegionIrene\\n    __typename\\n  }\\n  wishlistData {\\n    numProperties\\n    __typename\\n  }\\n  seoThemes {\\n    id\\n    caption\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment BasicPropertyData on SearchResultProperty {\\n  acceptsWalletCredit\\n  basicPropertyData {\\n    accommodationTypeId\\n    id\\n    isTestProperty\\n    location {\\n      address\\n      city\\n      countryCode\\n      __typename\\n    }\\n    pageName\\n    ufi\\n    photos {\\n      main {\\n        highResUrl {\\n          relativeUrl\\n          __typename\\n        }\\n        lowResUrl {\\n          relativeUrl\\n          __typename\\n        }\\n        highResJpegUrl {\\n          relativeUrl\\n          __typename\\n        }\\n        lowResJpegUrl {\\n          relativeUrl\\n          __typename\\n        }\\n        __typename\\n      }\\n      __typename\\n    }\\n    reviewScore: reviews {\\n      score: totalScore\\n      reviewCount: reviewsCount\\n      totalScoreTextTag {\\n        translation\\n        __typename\\n      }\\n      showScore\\n      secondaryScore\\n      secondaryTextTag {\\n        translation\\n        __typename\\n      }\\n      showSecondaryScore\\n      __typename\\n    }\\n    externalReviewScore: externalReviews {\\n      score: totalScore\\n      reviewCount: reviewsCount\\n      showScore\\n      totalScoreTextTag {\\n        translation\\n        __typename\\n      }\\n      __typename\\n    }\\n    starRating {\\n      value\\n      symbol\\n      caption {\\n        translation\\n        __typename\\n      }\\n      tocLink {\\n        translation\\n        __typename\\n      }\\n      showAdditionalInfoIcon\\n      __typename\\n    }\\n    isClosed\\n    paymentConfig {\\n      installments {\\n        minPriceFormatted\\n        maxAcceptCount\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  badges {\\n    caption {\\n      translation\\n      __typename\\n    }\\n    closedFacilities {\\n      startDate\\n      endDate\\n      __typename\\n    }\\n    __typename\\n  }\\n  customBadges {\\n    showSkiToDoor\\n    showBhTravelCreditBadge\\n    showOnlineCheckinBadge\\n    __typename\\n  }\\n  description {\\n    text\\n    __typename\\n  }\\n  displayName {\\n    text\\n    translationTag {\\n      translation\\n      __typename\\n    }\\n    __typename\\n  }\\n  geniusInfo {\\n    benefitsCommunication {\\n      header {\\n        title\\n        __typename\\n      }\\n      items {\\n        title\\n        __typename\\n      }\\n      __typename\\n    }\\n    geniusBenefits\\n    geniusBenefitsData {\\n      hotelCardHasFreeBreakfast\\n      hotelCardHasFreeRoomUpgrade\\n      sortedBenefits\\n      __typename\\n    }\\n    showGeniusRateBadge\\n    __typename\\n  }\\n  location {\\n    displayLocation\\n    mainDistance\\n    publicTransportDistanceDescription\\n    skiLiftDistance\\n    beachDistance\\n    nearbyBeachNames\\n    beachWalkingTime\\n    geoDistanceMeters\\n    __typename\\n  }\\n  mealPlanIncluded {\\n    mealPlanType\\n    text\\n    __typename\\n  }\\n  persuasion {\\n    autoextended\\n    geniusRateAvailable\\n    highlighted\\n    preferred\\n    preferredPlus\\n    showNativeAdLabel\\n    nativeAdId\\n    nativeAdsCpc\\n    nativeAdsTracking\\n    sponsoredAdsData {\\n      isDsaCompliant\\n      legalEntityName\\n      sponsoredAdsDesign\\n      __typename\\n    }\\n    __typename\\n  }\\n  policies {\\n    showFreeCancellation\\n    showNoPrepayment\\n    enableJapaneseUsersSpecialCase\\n    __typename\\n  }\\n  ribbon {\\n    ribbonType\\n    text\\n    __typename\\n  }\\n  recommendedDate {\\n    checkin\\n    checkout\\n    lengthOfStay\\n    __typename\\n  }\\n  showGeniusLoginMessage\\n  hostTraderLabel\\n  soldOutInfo {\\n    isSoldOut\\n    messages {\\n      text\\n      __typename\\n    }\\n    alternativeDatesMessages {\\n      text\\n      __typename\\n    }\\n    __typename\\n  }\\n  nbWishlists\\n  visibilityBoosterEnabled\\n  showAdLabel\\n  isNewlyOpened\\n  propertySustainability {\\n    isSustainable\\n    tier {\\n      type\\n      __typename\\n    }\\n    facilities {\\n      id\\n      __typename\\n    }\\n    certifications {\\n      name\\n      __typename\\n    }\\n    chainProgrammes {\\n      chainName\\n      programmeName\\n      __typename\\n    }\\n    levelId\\n    __typename\\n  }\\n  seoThemes {\\n    caption\\n    __typename\\n  }\\n  relocationMode {\\n    distanceToCityCenterKm\\n    distanceToCityCenterMiles\\n    distanceToOriginalHotelKm\\n    distanceToOriginalHotelMiles\\n    phoneNumber\\n    __typename\\n  }\\n  bundleRatesAvailable\\n  __typename\\n}\\n\\nfragment Banner on Banner {\\n  name\\n  type\\n  isDismissible\\n  showAfterDismissedDuration\\n  position\\n  requestAlternativeDates\\n  merchId\\n  title {\\n    text\\n    __typename\\n  }\\n  imageUrl\\n  paragraphs {\\n    text\\n    __typename\\n  }\\n  metadata {\\n    key\\n    value\\n    __typename\\n  }\\n  pendingReviewInfo {\\n    propertyPhoto {\\n      lowResUrl {\\n        relativeUrl\\n        __typename\\n      }\\n      lowResJpegUrl {\\n        relativeUrl\\n        __typename\\n      }\\n      __typename\\n    }\\n    propertyName\\n    urlAccessCode\\n    __typename\\n  }\\n  nbDeals\\n  primaryAction {\\n    text {\\n      text\\n      __typename\\n    }\\n    action {\\n      name\\n      context {\\n        key\\n        value\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  secondaryAction {\\n    text {\\n      text\\n      __typename\\n    }\\n    action {\\n      name\\n      context {\\n        key\\n        value\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  iconName\\n  flexibleFilterOptions {\\n    optionId\\n    filterName\\n    __typename\\n  }\\n  trackOnView {\\n    type\\n    experimentHash\\n    value\\n    __typename\\n  }\\n  dateFlexQueryOptions {\\n    text {\\n      text\\n      __typename\\n    }\\n    action {\\n      name\\n      context {\\n        key\\n        value\\n        __typename\\n      }\\n      __typename\\n    }\\n    isApplied\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment Carousel on Carousel {\\n  aggregatedCountsByFilterId\\n  carouselId\\n  position\\n  contentType\\n  hotelId\\n  name\\n  soldoutProperties\\n  priority\\n  themeId\\n  frontierThemeIds\\n  title {\\n    text\\n    __typename\\n  }\\n  slides {\\n    captionText {\\n      text\\n      __typename\\n    }\\n    name\\n    photoUrl\\n    subtitle {\\n      text\\n      __typename\\n    }\\n    type\\n    title {\\n      text\\n      __typename\\n    }\\n    action {\\n      context {\\n        key\\n        value\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment DestinationLocation on DestinationLocation {\\n  name {\\n    text\\n    __typename\\n  }\\n  inName {\\n    text\\n    __typename\\n  }\\n  countryCode\\n  ufi\\n  __typename\\n}\\n\\nfragment FilterData on Filter {\\n  trackOnView {\\n    type\\n    experimentHash\\n    value\\n    __typename\\n  }\\n  trackOnClick {\\n    type\\n    experimentHash\\n    value\\n    __typename\\n  }\\n  name\\n  field\\n  category\\n  filterStyle\\n  title {\\n    text\\n    translationTag {\\n      translation\\n      __typename\\n    }\\n    __typename\\n  }\\n  subtitle\\n  options {\\n    parentId\\n    genericId\\n    trackOnView {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnClick {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnSelect {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnDeSelect {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnViewPopular {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnClickPopular {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnSelectPopular {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnDeSelectPopular {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    ...FilterOption\\n    __typename\\n  }\\n  filterLayout {\\n    isCollapsable\\n    collapsedCount\\n    __typename\\n  }\\n  stepperOptions {\\n    min\\n    max\\n    default\\n    selected\\n    title {\\n      text\\n      translationTag {\\n        translation\\n        __typename\\n      }\\n      __typename\\n    }\\n    field\\n    labels {\\n      text\\n      translationTag {\\n        translation\\n        __typename\\n      }\\n      __typename\\n    }\\n    trackOnView {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnClick {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnSelect {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnDeSelect {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnClickDecrease {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnClickIncrease {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnDecrease {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    trackOnIncrease {\\n      type\\n      experimentHash\\n      value\\n      __typename\\n    }\\n    __typename\\n  }\\n  sliderOptions {\\n    min\\n    max\\n    minSelected\\n    maxSelected\\n    minPriceStep\\n    minSelectedFormatted\\n    currency\\n    histogram\\n    selectedRange {\\n      translation\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment FilterOption on Option {\\n  optionId: id\\n  count\\n  selected\\n  urlId\\n  source\\n  additionalLabel {\\n    text\\n    translationTag {\\n      translation\\n      __typename\\n    }\\n    __typename\\n  }\\n  value {\\n    text\\n    translationTag {\\n      translation\\n      __typename\\n    }\\n    __typename\\n  }\\n  starRating {\\n    value\\n    symbol\\n    caption {\\n      translation\\n      __typename\\n    }\\n    showAdditionalInfoIcon\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment LandingPageBreadcrumb on LandingPageBreadcrumb {\\n  destType\\n  name\\n  urlParts\\n  __typename\\n}\\n\\nfragment MatchingUnitConfigurations on SearchResultProperty {\\n  matchingUnitConfigurations {\\n    commonConfiguration {\\n      name\\n      unitId\\n      bedConfigurations {\\n        beds {\\n          count\\n          type\\n          __typename\\n        }\\n        nbAllBeds\\n        __typename\\n      }\\n      nbAllBeds\\n      nbBathrooms\\n      nbBedrooms\\n      nbKitchens\\n      nbLivingrooms\\n      nbUnits\\n      unitTypeNames {\\n        translation\\n        __typename\\n      }\\n      localizedArea {\\n        localizedArea\\n        unit\\n        __typename\\n      }\\n      __typename\\n    }\\n    unitConfigurations {\\n      name\\n      unitId\\n      bedConfigurations {\\n        beds {\\n          count\\n          type\\n          __typename\\n        }\\n        nbAllBeds\\n        __typename\\n      }\\n      apartmentRooms {\\n        config {\\n          roomId: id\\n          roomType\\n          bedTypeId\\n          bedCount: count\\n          __typename\\n        }\\n        roomName: tag {\\n          tag\\n          translation\\n          __typename\\n        }\\n        __typename\\n      }\\n      nbAllBeds\\n      nbBathrooms\\n      nbBedrooms\\n      nbKitchens\\n      nbLivingrooms\\n      nbUnits\\n      unitTypeNames {\\n        translation\\n        __typename\\n      }\\n      localizedArea {\\n        localizedArea\\n        unit\\n        __typename\\n      }\\n      unitTypeId\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment PropertyBlocks on SearchResultProperty {\\n  blocks {\\n    blockId {\\n      roomId\\n      occupancy\\n      policyGroupId\\n      packageId\\n      mealPlanId\\n      __typename\\n    }\\n    finalPrice {\\n      amount\\n      currency\\n      __typename\\n    }\\n    originalPrice {\\n      amount\\n      currency\\n      __typename\\n    }\\n    onlyXLeftMessage {\\n      tag\\n      variables {\\n        key\\n        value\\n        __typename\\n      }\\n      translation\\n      __typename\\n    }\\n    freeCancellationUntil\\n    hasCrib\\n    blockMatchTags {\\n      childStaysForFree\\n      __typename\\n    }\\n    thirdPartyInventoryContext {\\n      isTpiBlock\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment PriceDisplayInfoIrene on PriceDisplayInfoIrene {\\n  badges {\\n    name {\\n      translation\\n      __typename\\n    }\\n    tooltip {\\n      translation\\n      __typename\\n    }\\n    style\\n    identifier\\n    __typename\\n  }\\n  chargesInfo {\\n    translation\\n    __typename\\n  }\\n  displayPrice {\\n    copy {\\n      translation\\n      __typename\\n    }\\n    amountPerStay {\\n      amount\\n      amountRounded\\n      amountUnformatted\\n      currency\\n      __typename\\n    }\\n    __typename\\n  }\\n  priceBeforeDiscount {\\n    copy {\\n      translation\\n      __typename\\n    }\\n    amountPerStay {\\n      amount\\n      amountRounded\\n      amountUnformatted\\n      currency\\n      __typename\\n    }\\n    __typename\\n  }\\n  rewards {\\n    rewardsList {\\n      termsAndConditions\\n      amountPerStay {\\n        amount\\n        amountRounded\\n        amountUnformatted\\n        currency\\n        __typename\\n      }\\n      breakdown {\\n        productType\\n        amountPerStay {\\n          amount\\n          amountRounded\\n          amountUnformatted\\n          currency\\n          __typename\\n        }\\n        __typename\\n      }\\n      __typename\\n    }\\n    rewardsAggregated {\\n      amountPerStay {\\n        amount\\n        amountRounded\\n        amountUnformatted\\n        currency\\n        __typename\\n      }\\n      copy {\\n        translation\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  useRoundedAmount\\n  discounts {\\n    amount {\\n      amount\\n      amountRounded\\n      amountUnformatted\\n      currency\\n      __typename\\n    }\\n    name {\\n      translation\\n      __typename\\n    }\\n    description {\\n      translation\\n      __typename\\n    }\\n    itemType\\n    productId\\n    __typename\\n  }\\n  excludedCharges {\\n    excludeChargesAggregated {\\n      copy {\\n        translation\\n        __typename\\n      }\\n      amountPerStay {\\n        amount\\n        amountRounded\\n        amountUnformatted\\n        currency\\n        __typename\\n      }\\n      __typename\\n    }\\n    excludeChargesList {\\n      chargeMode\\n      chargeInclusion\\n      chargeType\\n      amountPerStay {\\n        amount\\n        amountRounded\\n        amountUnformatted\\n        currency\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  taxExceptions {\\n    shortDescription {\\n      translation\\n      __typename\\n    }\\n    longDescription {\\n      translation\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment BookerExperienceData on SearchResultProperty {\\n  bookerExperienceContentUIComponentProps {\\n    ... on BookerExperienceContentLoyaltyBadgeListProps {\\n      badges {\\n        variant\\n        key\\n        title\\n        popover\\n        logoSrc\\n        logoAlt\\n        __typename\\n      }\\n      __typename\\n    }\\n    ... on BookerExperienceContentFinancialBadgeProps {\\n      paymentMethod\\n      backgroundColor\\n      hideAccepted\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment SearchMetadata on SearchMeta {\\n  availabilityInfo {\\n    hasLowAvailability\\n    unavailabilityPercent\\n    totalAvailableNotAutoextended\\n    __typename\\n  }\\n  boundingBoxes {\\n    swLat\\n    swLon\\n    neLat\\n    neLon\\n    type\\n    __typename\\n  }\\n  childrenAges\\n  dates {\\n    checkin\\n    checkout\\n    lengthOfStayInDays\\n    __typename\\n  }\\n  destId\\n  destType\\n  guessedLocation {\\n    destId\\n    destType\\n    destName\\n    __typename\\n  }\\n  maxLengthOfStayInDays\\n  nbRooms\\n  nbAdults\\n  nbChildren\\n  userHasSelectedFilters\\n  customerValueStatus\\n  isAffiliateBookingOwned\\n  affiliatePartnerChannelId\\n  affiliateVerticalType\\n  geniusLevel\\n  __typename\\n}\\n\\nfragment SearchResultsBreadcrumb on SearchResultsBreadcrumb {\\n  destId\\n  destType\\n  name\\n  __typename\\n}\\n\\nfragment SorterFields on SorterOption {\\n  type: name\\n  captionTranslationTag {\\n    translation\\n    __typename\\n  }\\n  tooltipTranslationTag {\\n    translation\\n    __typename\\n  }\\n  isSelected: selected\\n  __typename\\n}\\n\\nfragment OneOfThreeDeal on OneOfThreeDeal {\\n  id\\n  uuid\\n  winnerHotelId\\n  winnerBlockId\\n  priceDisplayInfoIrene {\\n    displayPrice {\\n      amountPerStay {\\n        amountRounded\\n        amountUnformatted\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  locationInfo {\\n    name\\n    inName\\n    destType\\n    __typename\\n  }\\n  destinationType\\n  commonFacilities {\\n    id\\n    name\\n    __typename\\n  }\\n  tpiParams {\\n    wholesalerCode\\n    rateKey\\n    rateBlockId\\n    bookingRoomId\\n    supplierId\\n    __typename\\n  }\\n  properties {\\n    priceDisplayInfoIrene {\\n      priceBeforeDiscount {\\n        amountPerStay {\\n          amountRounded\\n          amountUnformatted\\n          __typename\\n        }\\n        __typename\\n      }\\n      displayPrice {\\n        amountPerStay {\\n          amountRounded\\n          amountUnformatted\\n          __typename\\n        }\\n        __typename\\n      }\\n      __typename\\n    }\\n    basicPropertyData {\\n      id\\n      name\\n      pageName\\n      photos {\\n        main {\\n          highResUrl {\\n            absoluteUrl\\n            __typename\\n          }\\n          __typename\\n        }\\n        __typename\\n      }\\n      location {\\n        address\\n        countryCode\\n        __typename\\n      }\\n      reviews {\\n        reviewsCount\\n        totalScore\\n        __typename\\n      }\\n      __typename\\n    }\\n    blocks {\\n      thirdPartyInventoryContext {\\n        rateBlockId\\n        rateKey\\n        wholesalerCode\\n        tpiRoom {\\n          bookingRoomId\\n          __typename\\n        }\\n        supplierId\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment TripTypesData on TripTypes {\\n  beach {\\n    isBeachUfi\\n    isEnabledBeachUfi\\n    __typename\\n  }\\n  ski {\\n    isSkiExperience\\n    isSkiScaleUfi\\n    __typename\\n  }\\n  __typename\\n}\\n\\nfragment ZeroResultsSection on ZeroResultsSection {\\n  title {\\n    text\\n    __typename\\n  }\\n  primaryAction {\\n    text {\\n      text\\n      __typename\\n    }\\n    action {\\n      name\\n      __typename\\n    }\\n    __typename\\n  }\\n  paragraphs {\\n    text\\n    __typename\\n  }\\n  type\\n  __typename\\n}\\n\\nfragment PreviousSearches on PreviousSearch {\\n  childrenAges\\n  __typename\\n}\\n\\nfragment FrontierThemes on FrontierTheme {\\n  id\\n  name\\n  selected\\n  __typename\\n}\\n\\nfragment MerchRegionIrene on MerchComponentsResultIrene {\\n  regions {\\n    id\\n    components {\\n      ... on PromotionalBannerIrene {\\n        promotionalBannerCampaignId\\n        contentArea {\\n          title {\\n            ... on PromotionalBannerSimpleTitleIrene {\\n              value\\n              __typename\\n            }\\n            __typename\\n          }\\n          subTitle {\\n            ... on PromotionalBannerSimpleSubTitleIrene {\\n              value\\n              __typename\\n            }\\n            __typename\\n          }\\n          caption {\\n            ... on PromotionalBannerSimpleCaptionIrene {\\n              value\\n              __typename\\n            }\\n            ... on PromotionalBannerCountdownCaptionIrene {\\n              campaignEnd\\n              __typename\\n            }\\n            __typename\\n          }\\n          buttons {\\n            variant\\n            cta {\\n              ariaLabel\\n              text\\n              targetLanding {\\n                ... on OpenContextSheet {\\n                  sheet {\\n                    ... on WebContextSheet {\\n                      title\\n                      body {\\n                        items {\\n                          ... on ContextSheetTextItem {\\n                            text\\n                            __typename\\n                          }\\n                          ... on ContextSheetList {\\n                            items {\\n                              text\\n                              __typename\\n                            }\\n                            __typename\\n                          }\\n                          __typename\\n                        }\\n                        __typename\\n                      }\\n                      buttons {\\n                        variant\\n                        cta {\\n                          text\\n                          ariaLabel\\n                          targetLanding {\\n                            ... on DirectLinkLanding {\\n                              urlPath\\n                              queryParams {\\n                                name\\n                                value\\n                                __typename\\n                              }\\n                              __typename\\n                            }\\n                            ... on LoginLanding {\\n                              stub\\n                              __typename\\n                            }\\n                            ... on DeeplinkLanding {\\n                              urlPath\\n                              queryParams {\\n                                name\\n                                value\\n                                __typename\\n                              }\\n                              __typename\\n                            }\\n                            ... on ResolvedLinkLanding {\\n                              url\\n                              __typename\\n                            }\\n                            __typename\\n                          }\\n                          __typename\\n                        }\\n                        __typename\\n                      }\\n                      __typename\\n                    }\\n                    __typename\\n                  }\\n                  __typename\\n                }\\n                ... on SearchResultsLandingIrene {\\n                  destType\\n                  destId\\n                  checkin\\n                  checkout\\n                  nrAdults\\n                  nrChildren\\n                  childrenAges\\n                  nrRooms\\n                  filters {\\n                    name\\n                    value\\n                    __typename\\n                  }\\n                  __typename\\n                }\\n                ... on DirectLinkLandingIrene {\\n                  urlPath\\n                  queryParams {\\n                    name\\n                    value\\n                    __typename\\n                  }\\n                  __typename\\n                }\\n                ... on LoginLandingIrene {\\n                  stub\\n                  __typename\\n                }\\n                ... on DeeplinkLandingIrene {\\n                  urlPath\\n                  queryParams {\\n                    name\\n                    value\\n                    __typename\\n                  }\\n                  __typename\\n                }\\n                ... on SorterLandingIrene {\\n                  sorterName\\n                  __typename\\n                }\\n                __typename\\n              }\\n              __typename\\n            }\\n            __typename\\n          }\\n          __typename\\n        }\\n        designVariant {\\n          ... on DesktopPromotionalFullBleedImageIrene {\\n            image: image {\\n              id\\n              url(width: 814, height: 138)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on DesktopPromotionalImageLeftIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 248, height: 248)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on DesktopPromotionalImageRightIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 248, height: 248)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on MdotPromotionalFullBleedImageIrene {\\n            image: image {\\n              id\\n              url(width: 358, height: 136)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on MdotPromotionalImageLeftIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 128, height: 128)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on MdotPromotionalImageRightIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 128, height: 128)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on MdotPromotionalImageTopIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 128, height: 128)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on MdotPromotionalIllustrationLeftIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 200, height: 200)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          ... on MdotPromotionalIllustrationRightIrene {\\n            imageOpt: image {\\n              id\\n              url(width: 200, height: 200)\\n              alt\\n              overlayGradient\\n              primaryColorHex\\n              __typename\\n            }\\n            colorScheme\\n            signature\\n            __typename\\n          }\\n          __typename\\n        }\\n        __typename\\n      }\\n      ... on MerchCarouselIrene @include(if: $carouselLowCodeExp) {\\n        carouselCampaignId\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n  __typename\\n}\\n\"\n}"

  request_body = JSON.parse(request.body)
  request_body['variables']['input']['location']['searchString'] = address
  request_body['variables']['input']['pagination']['rowsPerPage'] = pageSize
  request.body = request_body.to_json

  response = https.request(request)
  if response.code.to_i != 200
    raise "Error: Received response code #{response.code}. Response body: #{response.body}"
  end
  
  result = JSON.parse(response.body)
  search_results = result.dig('data','searchQueries','search','results')

  CSV.open(file_path, 'w') do |csv|
    csv << ['Listing ID', 'Listing Title', 'Page Name', 'Amount']
    search_results.each do |row|
      csv << [
        row.dig('basicPropertyData', 'id'),
        row.dig('displayName', 'text'),
        row.dig('basicPropertyData', 'pageName'),
        row.dig('priceDisplayInfoIrene', 'priceBeforeDiscount', 'displayPrice', 'amountPerStay', 'amount')
      ]
    end
  end
end

def build_query_params(uri)
  query_params = {}
  params = [
    { "key": 'label',
      "value": 'gen173nr-1BCAEoggI46AdIM1gEaGyIAQGYAQm4AQfIAQzYAQHoAQGIAgGoAgO4AofIxbMGwAIB0gIkNDFkMDkyZDktMDFlZC00NzMxLTkyMjMtNGFhYWIxNjEwMjg12AIF4AIB' },
    { "key": 'sid', "value": 'aa4f62f572ac5f487c282f0f11ec409c' },
    { "key": 'aid', "value": '304142' },
    { "key": 'ss', "value": 'Bangalore' },
    { "key": 'ssne', "value": 'Bangalore' },
    { "key": 'ssne_untouched', "value": 'Bangalore' },
    { "key": 'lang', "value": 'en-gb' },
    { "key": 'src', "value": 'index' },
    { "key": 'dest_id', "value": '-2090174' },
    { "key": 'dest_type', "value": 'city' },
    { "key": 'checkin', "value": '2024-06-18' },
    { "key": 'checkout', "value": '2024-06-19' },
    { "key": 'group_adults', "value": '1' },
    { "key": 'no_rooms', "value": '1' },
    { "key": 'group_children', "value": '0' },
    { "key": 'nflt', "value": 'distance=3000' }
  ]
  params.each do |obj|
    query_params[obj[:key].to_sym] = obj[:value]
  end
  query_params
end

def build_headers
  [
    { "key": 'accept', "value": '*/*', "uuid": '860b6f08-b948-446c-8b57-b7d7c291ddd7' },
    { "key": 'accept-language', "value": 'en-GB,en;q=0.7', "uuid": '177569a5-061e-4f67-bdb4-d7947d0da6f1' },
    { "key": 'content-type', "value": 'application/json', "uuid": 'e79cf217-0cf4-4a7d-8fb6-4eaefb0a28c4' },
    { "key": 'cookie',
      "value": 'px_init=0; pcm_consent=analytical%3Dtrue%26countryCode%3DIN%26consentId%3Def552b9e-a259-4741-ad3a-e66db563ec9c%26consentedAt%3D2024-02-29T14%3A48%3A18.689Z%26expiresAt%3D2024-08-27T14%3A48%3A18.689Z%26implicit%3Dtrue%26marketing%3Dtrue%26regionCode%3DKA%26regulation%3Dnone%26legacyRegulation%3Dnone; bkng_sso_session=e30; bkng_sso_ses=e30; _pxhd=l1VHnFED432P4U6wG-B5VP9%2F46XzrG7Qv8lfOB8g2HN265AlW8BB6AP98WWPzjdhLQAwiMtiKf4LV5y2pbS6QQ%3D%3D%3AM4mRLb4ORiG5aLq5Mil%2FFBL%2FucckryNyUxrxSgFtrF2L4x310dL3r9Rv%2FuUltSC3pk4Y%2FfIlRNQYFKAUNBPs04UgQNbn1ani1YpbAZT%2FCfc%3D; pxcts=aa860a0d-d711-11ee-9e8d-f6ec8a89a25b; bs=%7B%22gc%22%3A1%7D; qr_is_sr=fast-click; 11_srd=%7B%22features%22%3A%5B%7B%22id%22%3A5%7D%5D%2C%22score%22%3A3%2C%22detected%22%3Afalse%7D; pcm_personalization_disabled=0; bkng_sso_auth=CAIQsOnuTRpmCvN2T1sxcM7wXLWbcQd6z0Cm6xaWBO9rQxOB9/ONnhf71l2kwxfJx3auoJfKUWOVHJrK5KkdNUhEkYNeJoe9o5Hmu7Iu65+ZJcWj+P6CJfn52bjP2LuDh1KKqYp9F5++eAAWsxbP; cors_js=1; BJS=-; aws-waf-token=eb71beb8-98b5-4eb6-bd21-9e817d992a68:HgoAikFJbishAAAA:kePYlBJb55HsoBGxx/Z8QHWZLfDjB298StazgQnecolRTcEM6kKLCfCbCrpHiiBkezeXlm2gIInb6zD96VJvKg6kWj4LUPTB3JIHc1Ueo4zmWJtW4kiUv1AMXkQf7itB3jWZzrxrfqQsjlEOJIE9izvW948rpf1aM47INlA/elWfva4dwgh7wMu+LXf88F0W7HIKOslLXyvaBKgZ; bkng=11UmFuZG9tSVYkc2RlIyh9YSvtNSM2ADX0BnR0tqAEmju3Hqww3f4xH1FWtu0PhSoE1GWriV3TDLv6gfUX9GITdglHqvXFXqI0DxpljqO8ImGlmzozNwIe1y9El%2Fk0KPyzFeJWurckAlX9ymWsW87Y3ZXs8HUZ1fkIFCFwjEGGJWczz4jdBC7DL0nNNu8G9sT6axa5eWgMRgwPTYXp7lgk5A%3D%3D; lastSeen=0', "uuid": '85d58e3c-6af3-4b2b-ac77-c7e23735b098' },
    { "key": 'origin', "value": 'https://www.booking.com', "uuid": 'b99029c5-9898-49b5-89b1-dd195c91540f' },
    { "key": 'referer',
      "value": 'https://www.booking.com/searchresults.en-gb.html?label=gen173nr-1BCAEoggI46AdIM1gEaGyIAQGYAQm4AQfIAQzYAQHoAQGIAgGoAgO4AofIxbMGwAIB0gIkNDFkMDkyZDktMDFlZC00NzMxLTkyMjMtNGFhYWIxNjEwMjg12AIF4AIB&sid=aa4f62f572ac5f487c282f0f11ec409c&aid=304142&ss=Bangalore&ssne=Bangalore&ssne_untouched=Bangalore&lang=en-gb&src=index&dest_id=-2090174&dest_type=city&checkin=2024-06-18&checkout=2024-06-19&group_adults=1&no_rooms=1&group_children=0&nflt=distance%3D3000', "uuid": 'ef62a1ff-d7c0-4edb-9390-bfe33ba7f2ef' },
    { "key": 'sec-ch-ua', "value": '"Brave";v="123", "Not:A-Brand";v="8", "Chromium";v="123"',
      "uuid": '6458584c-0c6e-4615-94b5-b0c8fde18051' },
    { "key": 'sec-ch-ua-mobile', "value": '?0', "uuid": 'a03a0ca4-c680-4979-9305-ef76c0a94dac' },
    { "key": 'sec-ch-ua-platform', "value": '"macOS"', "uuid": 'c1e81a11-7cd4-421e-90f9-a08cb58be31f' },
    { "key": 'sec-fetch-dest', "value": 'empty', "uuid": 'e2248c58-ce93-4f31-8bd7-27ec84bcfcbc' },
    { "key": 'sec-fetch-mode', "value": 'cors', "uuid": 'a75e6191-395a-4279-9173-ee298137e1fa' },
    { "key": 'sec-fetch-site', "value": 'same-origin', "uuid": '2a3efe12-d820-4912-a27e-72bdfd420c0b' },
    { "key": 'sec-gpc', "value": '1', "uuid": 'b32e2737-a214-4f40-ad47-6479962124fa' },
    { "key": 'user-agent',
      "value": 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36', "uuid": '13fa19a3-92f1-4bbf-89b7-4cdaa04bccb4' },
    { "key": 'x-booking-context-action-name', "value": 'searchresults_irene',
      "uuid": 'bc487fbb-3803-4845-bb2b-ce9e1e1de752' },
    { "key": 'x-booking-context-aid', "value": '304142', "uuid": '29ef2117-967d-4365-9c73-6998fc3296a2' },
    { "key": 'x-booking-csrf-token',
      "value": 'eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJjb250ZXh0LWVucmljaG1lbnQtYXBpIiwic3ViIjoiY3NyZi10b2tlbiIsImlhdCI6MTcxODcwNzI1NywiZXhwIjoxNzE4NzkzNjU3fQ.gA_WWPhKkgTxDbcyKB-uFUsf_obvRlbvoXZdZFmcJ6EkASNrqdWTR52ltzPSWG_WgOBQBZYGklU3KfhgMTWldg', "uuid": 'f32ca107-2e83-4004-9572-f98261311a62' },
    { "key": 'x-booking-et-serialized-state',
      "value": 'E2VhNDBFc4_90QQbS9aUekVBL5O2uMzHdM99N6US3R1fVugRNyessdEVjxWsuup9I', "uuid": 'a62d0005-a43f-4a87-be2f-3076b86bc388' },
    { "key": 'x-booking-pageview-id', "value": 'cd2e4b1c6a810062', "uuid": 'df844466-809a-4609-934d-470cf7eec208' },
    { "key": 'x-booking-site-type-id', "value": '1', "uuid": 'f3fa3f58-abf0-4d51-98c5-b46c2a4d7de6' },
    { "key": 'x-booking-topic', "value": 'capla_browser_b-search-web-searchresults',
      "uuid": '8380b7f8-7f31-45bf-bc93-3b256e685357' }
  ]
end

get_data('Bangalore', 20)
